<!DOCTYPE html>
<meta charset="utf-8">
<style>

body,
svg {
  height: 100%;
  margin: 0;
  width: 100%;
  float: left;
}

path {
  fill: none;
  stroke-linejoin: round;
}


.state-boundary {
        fill: none;
        stroke: #fff;
        stroke-width:1px;
        pointer-events: none;
}

.land-fill,
.county-boundary {
  stroke: #ccc;
  stroke-width: .7px;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="js/albers-usa.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>

<script>

var width = 800,
    height = 500;
var counties, rateByFips;
var dataDate = "dec2012";

var projection = albersUsa();

var path = d3.geo.path()
    .projection(projection);

var color = d3.scale.threshold()
    .domain([-0.1,1e-6, 0.1, 0.3, 0.5, 0.75, 0.9])
    .range(["#C51B7D", "#DE77AE", "#F1B6DA", "#FDE0EF", "#E6F5D0", "#B8E186", "#7FBC41", "#4D9221"]);

var svg = d3.select("body").append("svg")
   // .attr("viewBox", "0 0 " + width + " " + height)
    .attr("width", width)
    .attr("height", height);

svg.append("filter")
    .attr("id", "glow")
  .append("feGaussianBlur")
    .attr("stdDeviation", 5);

queue()
    .defer(d3.json, "data/us.json")
    .defer(d3.tsv, "data/bb_avai_county.tsv")
    .defer(d3.json, "data/us-state-labels.json")
    .await(ready);

function ready(error, us, rates, labels) {
  rate = rates;
  counties = topojson.object(us, us.objects.counties).geometries;
  rates.forEach(function(d) {
        d.fips = parseInt(d.fips, 10);
      });
  rateByFips= d3.nest()
                .key(function(d){return d.fips})
                .map(rates);
  svg.append("g")
      .attr("class", "g-county")
    .selectAll("path")
      .data(counties)
    .enter().append("path")
      .attr("d", path)
      .style("fill", function(d) {
        //return "red"
          if (typeof rateByFips[d.id]!= "undefined"){  
            var countyRateRow = rateByFips[d.id][0];
            return countyRateRow ? color(+countyRateRow[dataDate]) : "#F2F0F7";
          }else{
            return "#F2F0F7";
          }

      })
     .on("mouseover", function(d) {console.log(d.id + " " +rateByFips[d.id][0][dataDate]); })
    //  .on("mouseout", function() { event.mouseout(); });

    svg.append("path")
            .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
            .attr("d", path)
            .attr("class", "state-boundary");


  // svg.append("path") // thin grey stroke for internal county boundaries
  //     .datum(topojson.mesh(us, us.objects.counties, function(a, b) { return a.id !== b.id && (a.id / 1000 | 0) === (b.id / 1000 | 0); }))
  //     .attr("d", path)
  //     .attr("class", "county-boundary");

};

</script>